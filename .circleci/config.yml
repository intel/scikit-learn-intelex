version: 2
jobs:
  build:
    docker:
      - image: circleci/python:3.6.7
    working_directory: ~/daal4py-ci
    steps:
      - checkout
      - run:
          name: Setting up build environment
          command: |
            wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh;
            bash miniconda.sh -b -p ~/miniconda
            export PATH=~/miniconda/bin:$PATH
            hash -r
            conda config --set always_yes yes --set changeps1 no
            conda update -q conda
            conda install -q conda-build
            conda create -q -n bld --override-channels -c intel -c conda-forge python=3.6 numpy scipy pytest daal tbb pandas numpydoc
            conda install -q -n bld -c defaults --override-channels --no-deps libgcc-ng libstdcxx-ng
            conda install -q -n bld -c conda-forge --override-channels --no-deps mpi libgfortran mpich
            conda install -c defaults pyyaml
            gcc -v
            g++ -v
            head /proc/cpuinfo
      - run:
          name: Building daal4py
          command: |
            . ~/miniconda/etc/profile.d/conda.sh
            conda activate bld
            mkdir -p /tmp/out
            conda build --python=36 --override-channels -c intel -c conda-forge --output-folder /tmp/out --no-test conda-recipe


  prepare-sklearn-pypi:
    docker:
      - image: circleci/python:3.6.7
    working_directory: ~/daal4py-ci
    steps:
      - run:
          name: Installing sklearn from pypi
          command: |
            export PATH=~/miniconda/bin:$PATH
            . ~/miniconda/etc/profile.d/conda.sh
            conda activate bld
            conda install -q /tmp/out/*/daal4py-*.tar.bz2
            pip install -q scikit-learn
            conda list


  prepare-sklearn-master:
    docker:
      - image: circleci/python:3.6.7
    working_directory: ~/daal4py-ci
    steps:
      - run:
          name: Installing sklearn from github master
          command: |
            export PATH=~/miniconda/bin:$PATH
            . ~/miniconda/etc/profile.d/conda.sh
            conda activate bld
            conda install -q /tmp/out/*/daal4py-*.tar.bz2
            git checkout https://github.com/scikit-learn/scikit-learn
            pushd scikit-learn
            python setup.py install
            conda list
            popd


  test-sklearn:
    docker:
      - image: circleci/python:3.6.7
    working_directory: ~/daal4py-ci
    steps:
      - run:
          name: Testing daal4py patches for scikit-learn
          command: |
            touch ~/d4p.out ~/skl.out
            export DESELECTED_TESTS=`python deselect_tests.py ../deselected_tests.yaml --absolute`
            echo "-m daal4py -m pytest ${DESELECTED_TESTS} -q -ra --disable-warnings --pyargs sklearn"
            # It is important for pytest to work in a separate test folder to not discover tests in ~/miniconda folder
            cd && ((python -m daal4py -m pytest ${DESELECTED_TESTS} -ra --disable-warnings --pyargs sklearn | tee ~/d4p.out) || true)
            cd && ((python -m pytest ${DESELECTED_TESTS} -ra --disable-warnings --pyargs sklearn | tee ~/skl.out) || true)
            export D4P=`grep -e '\d* passed.* second' ~/d4p.out`
            export SKL=`grep -e '\d* passed.* second' ~/skl.out`
            tar cjf /tmp/patched_and_unpatched_sklearn_pypi_pytest_logs.tar.bz2 ~/d4p.out ~/skl.out
            echo "Summary of patched run: " $D4P
            echo "Summary of unpatched run: " $SKL
            python ~/daal4py-ci/.circleci/compare_runs.py


  publish-pypi:
    docker:
      - image: circleci/python:3.6.7
    steps:
      - store_artifacts:
          path: /tmp/patched_and_unpatched_sklearn_pytest_logs.tar.bz2
          destination: patched_and_unpatched_sklearn_pypi_pytest_logs.tar.bz2


  publish-master:
    docker:
      - image: circleci/python:3.6.7
    steps:
      - store_artifacts:
          path: /tmp/patched_and_unpatched_sklearn_pytest_logs.tar.bz2
          destination: patched_and_unpatched_sklearn_master_pytest_logs.tar.bz2


workflows:
  version: 2
  on_commit:
    jobs:
      - build
      - prepare-sklearn-pypi:
          requires:
            - build
      - test-sklearn:
          requires:
            - prepare-sklearn-pypi
      - publish-pypi:
          requires:
            - test-sklearn

  nightly:
    triggers:
      - schedule:
          cron: "55 23 * * *"
          filters:
            branches:
              only:
                - master
    jobs:
      - build
      - prepare-sklearn-master:
          requires:
            - build
      - test-sklearn:
          requires:
            - prepare-sklearn-master
      - publish-master:
          requires:
            - test-sklearn
