version: 2
jobs:
  build:
    docker:
      - image: circleci/python:3.6.7

    working_directory: ~/daal4py-ci

    steps:
      - checkout
      - run:
          name: Setting up build environment
          command: |
            cat /proc/cpuinfo | head
            wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh;
            bash miniconda.sh -b -p ~/miniconda
            export PATH=~/miniconda/bin:$PATH
            hash -r
            conda config --set always_yes yes --set changeps1 no
            conda update -q conda
            conda install -q conda-build
            conda create -q -n bld --override-channels -c intel -c conda-forge python=3.6 numpy scipy pytest daal mpich tbb
            gcc -v
            g++ -v
      - run:
          name: Building daal4py
          command: |
            . ~/miniconda/bin/activate bld
            conda build --python=36 --override-channels -c intel -c conda-forge --output-folder ./ conda-recipe
            tar cfj build/daal4py-gen-srcs.tar.bz2 build/*.pyx build/*.h build/*.cpp
      - store_artifacts:
            path: ./*/daal4py-*.tar.bz2
      - run:
          name: Testing sklearn patches
          command: |
            export PATH=~/miniconda/bin:$PATH
            . activate bld
            conda install -q ./*/daal4py-*.tar.bz2
            pip install -q scikit-learn
            conda list
            touch ~/d4p.out ~/skl.out
            cd && ((python -m daal4py -m pytest --disable-warnings --pyargs sklearn | tee ~/d4p.out) || true)
            cd && ((python -m pytest --disable-warnings --pyargs sklearn | tee ~/skl.out) || true)
            D4P=`grep -e 'failed,.*passed,.*skipped,.*xfailed,' ~/d4p.out | awk '{print($1, $3, $5, $7, $9)}'`
            SKL=`grep -e 'failed,.*passed,.*skipped,.*xfailed,' ~/skl.out | awk '{print($1, $3, $5, $7, $9)}'`
            if [ "$D4P" = "$SKL" ]; then exit 0 ; else exit 1 ; fi
