jobs:
- job: DPCPP
  pool:
    vmImage: 'ubuntu-18.04'
  steps:
  - script: |
      wget https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS-2023.PUB
      sudo apt-key add GPG-PUB-KEY-INTEL-SW-PRODUCTS-2023.PUB
      rm GPG-PUB-KEY-INTEL-SW-PRODUCTS-2023.PUB
      echo "deb https://apt.repos.intel.com/oneapi all main" | sudo tee /etc/apt/sources.list.d/oneAPI.list
      sudo add-apt-repository -y "deb https://apt.repos.intel.com/oneapi all main"
      sudo apt-get update
      sudo apt-get install              \
          intel-oneapi-common-vars      \
          intel-oneapi-common-licensing \
          intel-oneapi-daal-devel       \
          intel-oneapi-dpcpp-compiler   \
          intel-oneapi-dev-utilities    \
          intel-oneapi-libdpstd-devel
      sudo bash -c 'echo libintelocl.so > /etc/OpenCL/vendors/intel-cpu.icd'
      sudo mv -f /opt/intel/oneapi/compiler/latest/linux/lib/oclfpga /opt/intel/oneapi/compiler/latest/linux/lib/oclfpga_
    displayName: 'apt-get'
  - script: conda create -q -y -n CB python=3.7 conda-build conda-verify
    displayName: Create Anaconda environment
  - script: |
      export DPCPPROOT=/opt/intel/oneapi/compiler/latest
      export DAALROOT=/opt/intel/oneapi/daal/latest
      export TBBROOT=/opt/intel/oneapi/tbb/latest
      . /usr/share/miniconda/etc/profile.d/conda.sh
      conda activate CB
      conda build --override-channels -c intel -c conda-forge -c defaults --numpy=1.17 conda-recipe
    displayName: conda build

- job: MacOS
  pool:
    vmImage: 'macOS-10.15'
    cCompiler: gcc
    cxxCompiler: g++
  steps:
  - script: |
      echo "!!! brew info gcc"
      brew info gcc
      echo "!!! brew install gcc@7"
      brew install gcc@10
      echo "!!! gcc --version"
      gcc --version
      echo "!!! gcc-10 --version"
      
      gcc-10 --version
      export PATH=/usr/local/Cellar/gcc/10.2.0/bin:$PATH
      cd /usr/local/Cellar/gcc/10.2.0/bin
      ln -s 10.2.0 gcc
      echo "which gcc"
      which gcc
      echo "!!! gcc --version"
      gcc --version
      cd -
      echo "##vso[task.prependpath]$CONDA/bin"
      sudo chown -R $USER $CONDA
    displayName: 'Install gcc'
  - script: |
      conda create -q -y -n CB -c conda-forge python=3.7 conda-forge::conda-build conda-verify
    displayName: Create Anaconda environment
  - script: |
      gcc -v
      clang -v
      conda env list
      export MACOSX_DEPLOYMENT_TARGET=10.15
      export CPATH=/Library/Developer/CommandLineTools/usr/include/c++/v1
      export SDKROOT="$(xcrun --sdk macosx --show-sdk-path)"
      source activate CB
      python --version
      sudo find /Library -name stdio.h 
      sudo xcode-select --install
      conda build --override-channels -c intel -c conda-forge -c defaults --numpy=1.17 conda-recipe
    displayName: conda build

- job: Windows
  pool:
    vmImage: 'vs2017-win2016'

  steps:
  - powershell: Write-Host "##vso[task.prependpath]$env:CONDA\Scripts"
    displayName: Add conda to PATH

  - script: conda create -q -y -n CB python=3.7 conda-build conda-verify
    displayName: Create Anaconda environment

  - script: |
      call activate CB
      conda build --override-channels -c conda-forge -c intel --output-folder=. conda-recipe
    displayName: conda build
